<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil del Usuario</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
    }

    .contenedor {
      max-width: 400px;
      margin: 40px auto;
      padding: 20px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .perfil-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    h2, h3 { text-align: center; margin-bottom: 15px; }

    form, .inicio-opciones {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }

    input {
      padding: 10px;
      font-size: 16px;
    }

    button {
      padding: 10px;
      background-color: #342E2E;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }

    .hidden { display: none !important; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    th { background-color: #f2f2f2; }

    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .botones-superior {
      display: flex;
      justify-content: flex-end;
      gap: 20px;
      margin-bottom: 10px;
    }

    .boton-link, .subtle-button {
      background: none;
      border: none;
      color: #342E2E;
      font-size: 14px;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
      font-family: inherit;
    }

    #datosUsuario input { display: none; }

    #tablaSolicitudesContainer { margin-top: 30px; }
    /* Estilos para la tabla de calendario de pagos */
#tablaCalendarioPagos th,
#tablaCalendarioPagos td {
  min-width: 90px;
  text-align: center;
  font-size: 13px;
  padding: 6px;
}

#tablaCalendarioPagos td:first-child {
  font-size: 14px;
  font-weight: bold;
  text-align: left;
  white-space: nowrap;
}

/* Estilo para cuotas ya pagadas (pasado) */
.cuota-pasada {
  font-style: italic;
  font-weight: bold;
  color: green;
  font-size: 11px;
}

/* Estilo para cuota del mes actual */
.cuota-actual {
  font-weight: bold;
  color: black;
  font-size: 13px;
}

/* Estilo para cuotas futuras */
.cuota-futura {
  font-style: italic;
  color: black;
  font-size: 11px;
}
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.popup-content {
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

.popup-content h4 {
  margin-bottom: 10px;
  text-align: center;
}

.popup-content p {
  margin: 6px 0;
}

.boton-carpeta {
  background: none;
  border: none;
  color: #342E2E;
  font-size: 14px;
  text-decoration: underline;
  cursor: pointer;
  padding: 0;
  font-family: inherit;
}
.boton-link {
  background: none;
  border: none;
  color: #342E2E;
  font-size: 14px;
  text-decoration: underline;
  cursor: pointer;
  padding: 0;
  font-family: inherit;
}



    #mensajeSinSolicitudes {
      margin-top: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
    }

    #formularioCarpeta input {
      padding: 6px;
      width: 200px;
      margin-right: 10px;
    }

    .atras {
      color: #342E2E;
      font-weight: bold;
      margin-bottom: 10px;
      cursor: pointer;
      text-decoration: underline;
      font-size: 14px;
    }

    #popupMensaje {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #342E2E;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 9999;
    }

    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .popup-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }

    .popup-content h4 {
      margin-bottom: 10px;
      text-align: center;
    }

    .popup-content p {
      margin: 6px 0;
    }

    @media (max-width: 768px) {
      .desktop-only { display: none; }
      .mobile-only { display: table; }
    }

    @media (min-width: 769px) {
      .mobile-only { display: none; }
    }
  </style>
</head>
<body>
<div class="contenedor" id="contenedor">
  <h2 id="titulo">Bienvenido</h2>
  <div class="inicio-opciones" id="opcionesInicio">
    <button onclick="mostrarLogin()">Iniciar Sesión</button>
    <button onclick="mostrarRegistro()">Registrarse</button>
  </div>
  <p id="btnAtrasLogin" class="atras hidden" onclick="volverAlInicio()">⬅ Atrás</p>
  <form id="loginForm" class="hidden">
    <input type="text" id="dniLogin" placeholder="DNI o Correo electrónico" required />
    <input type="password" id="passwordLogin" placeholder="Contraseña" required />
    <button type="submit">Ingresar</button>
    <p class="atras">
  <a href="/recuperar" style="text-decoration: underline; color: #342E2E;">¿Olvidaste tu contraseña?</a>
</p>
  </form>
  <p id="btnAtrasRegistro" class="atras hidden" onclick="volverAlInicio()">⬅ Atrás</p>
  <form id="registerForm" class="hidden">
    <input type="text" id="nombreRegister" placeholder="Nombre completo" required />
    <input type="text" id="dniRegister" placeholder="DNI" required />
    <input type="email" id="mailRegister" placeholder="Correo electrónico" required />
    <input type="text" id="telefonoRegister" placeholder="Teléfono" required />
    <input type="password" id="passwordRegister" placeholder="Contraseña" required />
    <button type="submit">Registrarse</button>
  </form>
</div>

<div id="perfilUsuario" class="perfil-container hidden">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 id="bienvenida" style="margin: 0;">Hola, Nicolas</h2>
    <div style="display: flex; gap: 15px;">
      <a href="https://mbeureka.com/simulador" class="boton-link" target="_blank">Simulador</a>
      <a href="#" class="boton-link" onclick="habilitarEdicion()">Editar Datos</a>
      <a href="#" class="boton-link" onclick="cerrarSesion()">Cerrar Sesión</a>
    </div>
  </div>

  <form id="perfilForm">
    <div id="datosUsuario">
      <input type="text" id="perfilNombre" required />
      <input type="email" id="perfilMail" required />
      <input type="text" id="perfilTelefono" required />
      <input type="password" id="perfilPassword" required />
    </div>
    <div class="flex-row" id="botonesEdicion" style="display: none;">
      <button type="submit">Guardar Cambios</button>
      <button type="button" onclick="cancelarEdicion()">Cancelar</button>
    </div>
  </form>


  <div id="tablaSolicitudesContainer">
    <h3>Mis Solicitudes</h3>
    <div style="margin-bottom: 10px;">
      <button onclick="mostrarFormularioCarpeta()">Agregar carpeta</button>
      <div id="formularioCarpeta" class="hidden" style="margin-top: 10px;">
        <input type="text" id="numeroCarpetaInput" placeholder="Número de carpeta" />
        <button onclick="buscarCarpeta()">Buscar</button>
        <div id="resultadoCarpeta" style="margin-top: 10px;"></div>
      </div>
    </div>
    <div id="mensajeSinSolicitudes" class="hidden">No se encuentran solicitudes asociadas a este número de DNI</div>

    <table id="tablaSolicitudes" class="desktop-only hidden">
      <thead>
        <tr>
          <th>Capital</th>
          <th>Períodos</th>
          <th>Ganancia</th>
          <th>Unidad</th>
          <th>Fecha</th>
          <th>Carpeta</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <table id="tablaMobile" class="mobile-only hidden">
      <thead>
        <tr>
          <th>Carpeta</th>
          <th>Capital</th>
          <th>Ganancia</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- CALENDARIO PAGOS -->
    <div id="calendarioPagosContainer" class="hidden" style="margin-top: 40px; overflow-x: auto;">
  <h3>Calendario de Pagos</h3>
  <table id="tablaCalendarioPagos">
    <thead>
      <tr id="calendarioHeader">
        <th>N° de Carpeta</th>
        <!-- Los meses se insertan dinámicamente acá -->
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

  </div>
</div>

<div id="popupMensaje" class="hidden">Texto</div>
<div id="popupOverlay" class="popup-overlay hidden">
  <div class="popup-content">
    <h4>Detalle de Carpeta</h4>
    <div id="popupInfo"></div>
    <button onclick="cerrarPopup()">Cerrar</button>
  </div>
</div>
<!-- Popup Detalle de Carpeta en Calendario -->
<div id="popupCarpetaCalendario" class="popup-overlay hidden">
  <div class="popup-content">
    <h4>Detalle de Carpeta</h4>
    <div id="popupCarpetaInfo"></div>
    <button onclick="cerrarPopupCalendario()">Cerrar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query,
    where, doc, updateDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyByH3CP-mOFo7Sz07F0E1015GtzrhyDDFI",
    authDomain: "eureka-724e4.firebaseapp.com",
    projectId: "eureka-724e4",
    storageBucket: "eureka-724e4.appspot.com",
    messagingSenderId: "505365749268",
    appId: "1:505365749268:web:85565579899d3bff235101",
    measurementId: "G-VBGL25Z494"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const usuariosRef = collection(db, "usuarios");
  const solicitudesRef = collection(db, "solicitudes");

  let usuarioActual = null;
  let usuarioDocId = null;

  function mostrarMensajePopup(texto) {
    const popup = document.getElementById("popupMensaje");
    popup.textContent = texto;
    popup.classList.remove("hidden");
    setTimeout(() => popup.classList.add("hidden"), 3000);
  }

  function mostrarFormularioCarpeta() {
    const form = document.getElementById("formularioCarpeta");
    form.classList.toggle("hidden");
  }

  async function registrar(e) {
    e.preventDefault();
    const nombre = document.getElementById("nombreRegister").value.trim();
    const dni = document.getElementById("dniRegister").value.trim();
    const mail = document.getElementById("mailRegister").value.trim();
    const telefono = document.getElementById("telefonoRegister").value.trim();
    const password = document.getElementById("passwordRegister").value.trim();

    const existe = await getDocs(query(usuariosRef, where("dni", "==", dni)));
    if (!existe.empty) return alert("Ya existe un usuario con ese DNI");

    await addDoc(usuariosRef, { nombre, dni, mail, telefono, password });

    mostrarMensajePopup("Registro exitoso, iniciando sesión...");
    setTimeout(() => {
      document.getElementById("dniLogin").value = dni;
      document.getElementById("passwordLogin").value = password;
      login(new Event("submit"));
    }, 3000);
  }

  async function login(e) {
    e.preventDefault();
    const identificador = document.getElementById("dniLogin").value.trim();
    const password = document.getElementById("passwordLogin").value.trim();

    const q = query(usuariosRef, where("password", "==", password), where("dni", "==", identificador));
    const qMail = query(usuariosRef, where("password", "==", password), where("mail", "==", identificador));

    const [resDni, resMail] = await Promise.all([getDocs(q), getDocs(qMail)]);
    const resultado = !resDni.empty ? resDni : resMail;

    if (resultado.empty) return alert("DNI/Mail o contraseña incorrectos");

    const docSnap = resultado.docs[0];
    usuarioActual = docSnap.data();
    usuarioDocId = docSnap.id;

    document.getElementById("contenedor").classList.add("hidden");
    document.getElementById("perfilUsuario").classList.remove("hidden");

    const nombreSolo = usuarioActual.nombre.split(" ")[0];
    document.getElementById("bienvenida").textContent = `Hola, ${nombreSolo}`;

    document.getElementById("perfilNombre").value = usuarioActual.nombre;
    document.getElementById("perfilMail").value = usuarioActual.mail;
    document.getElementById("perfilTelefono").value = usuarioActual.telefono;
    document.getElementById("perfilPassword").value = usuarioActual.password;

    cancelarEdicion();
    cargarSolicitudesDelUsuario(usuarioActual.dni);
  }

  function mostrarLogin() {
    document.getElementById("opcionesInicio").classList.add("hidden");
    document.getElementById("loginForm").classList.remove("hidden");
    document.getElementById("registerForm").classList.add("hidden");
    document.getElementById("btnAtrasLogin").classList.remove("hidden");
    document.getElementById("btnAtrasRegistro").classList.add("hidden");
    document.getElementById("titulo").textContent = "Iniciar Sesión";
  }

  function mostrarRegistro() {
    document.getElementById("opcionesInicio").classList.add("hidden");
    document.getElementById("registerForm").classList.remove("hidden");
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("btnAtrasRegistro").classList.remove("hidden");
    document.getElementById("btnAtrasLogin").classList.add("hidden");
    document.getElementById("titulo").textContent = "Registrarse";
  }

  function volverAlInicio() {
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("registerForm").classList.add("hidden");
    document.getElementById("btnAtrasLogin").classList.add("hidden");
    document.getElementById("btnAtrasRegistro").classList.add("hidden");
    document.getElementById("opcionesInicio").classList.remove("hidden");
    document.getElementById("titulo").textContent = "Bienvenido";
  }

  function cerrarSesion() {
    usuarioActual = null;
    usuarioDocId = null;
    document.getElementById("perfilUsuario").classList.add("hidden");
    document.getElementById("contenedor").classList.remove("hidden");
    volverAlInicio();
  }

  function habilitarEdicion() {
    const campos = ["perfilNombre", "perfilMail", "perfilTelefono", "perfilPassword"];
    campos.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.disabled = false;
        input.style.display = "block";
      }
    });
    document.getElementById("botonesEdicion").style.display = "flex";
  }

  function cancelarEdicion() {
    if (!usuarioActual) return;
    const campos = ["perfilNombre", "perfilMail", "perfilTelefono", "perfilPassword"];
    campos.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.value = usuarioActual[id.replace("perfil", "").toLowerCase()];
        input.disabled = true;
        input.style.display = "none";
      }
    });
    document.getElementById("botonesEdicion").style.display = "none";
  }

  async function guardarCambiosPerfil(e) {
    e.preventDefault();
    if (!usuarioDocId) return;
    const nuevo = {
      nombre: document.getElementById("perfilNombre").value.trim(),
      mail: document.getElementById("perfilMail").value.trim(),
      telefono: document.getElementById("perfilTelefono").value.trim(),
      password: document.getElementById("perfilPassword").value.trim()
    };
    await updateDoc(doc(db, "usuarios", usuarioDocId), nuevo);
    usuarioActual = { ...usuarioActual, ...nuevo };
    alert("Datos actualizados correctamente.");
    cancelarEdicion();
  }

  function formatearCapital(valor) {
    const numero = parseFloat(valor?.toString().replace(/[^\d,.-]/g, '').replace(',', '.'));
    return isNaN(numero) ? "-" : `USD ${Math.round(numero).toLocaleString("de-DE")}`;
  }

  function formatearGanancia(valor) {
  const limpio = valor?.toString().replace(",", ".");
  const numero = parseFloat(limpio);
  if (isNaN(numero)) return "-";
  const porcentaje = numero <= 1 ? numero * 100 : numero;
  return `${porcentaje.toFixed(1)}%`;
}



  function formatearFecha(fechaStr) {
    if (!fechaStr) return "-";
    const [y, m, d] = fechaStr.split("-");
    return `${d}-${m}-${y}`;
  }

  async function cargarSolicitudesDelUsuario(dni) {
    const tbody = document.querySelector("#tablaSolicitudes tbody");
    const tbodyMobile = document.querySelector("#tablaMobile tbody");
    const tabla = document.getElementById("tablaSolicitudes");
    const tablaMobile = document.getElementById("tablaMobile");
    const mensaje = document.getElementById("mensajeSinSolicitudes");

    tbody.innerHTML = "";
    tbodyMobile.innerHTML = "";

    const solicitudesTotales = [];

    const propias = await getDocs(query(solicitudesRef, where("dni", "==", dni)));
    for (const docSnap of propias.docs) {
  const data = docSnap.data();
  const reingresosSnap = await getDocs(collection(doc(db, "solicitudes", docSnap.id), "reingresos"));
  const reingresos = reingresosSnap.docs.map(r => r.data());
  solicitudesTotales.push({ ...data, reingresos });
}

    const vinculadasRef = collection(db, `usuarios/${usuarioDocId}/carpetasVinculadas`);
    const vinculadasSnap = await getDocs(vinculadasRef);

    for (const docV of vinculadasSnap.docs) {
      const idCarpeta = docV.data().carpeta;
      const match = await getDocs(query(solicitudesRef, where("carpeta", "==", idCarpeta)));
      for (const docSnap of match.docs) {
  const data = docSnap.data();
  const reingresosSnap = await getDocs(collection(doc(db, "solicitudes", docSnap.id), "reingresos"));
  const reingresos = reingresosSnap.docs.map(r => r.data());
  solicitudesTotales.push({ ...data, reingresos });
}

    }
    solicitudesTotales.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));


    if (solicitudesTotales.length === 0) {
      tabla.classList.add("hidden");
      tablaMobile.classList.add("hidden");
      mensaje.classList.remove("hidden");
      return;
    }

    mensaje.classList.add("hidden");
    tabla.classList.remove("hidden");
    tablaMobile.classList.remove("hidden");

    solicitudesTotales.forEach(s => {
  const row = tbody.insertRow();
  row.innerHTML = `
    <td>${formatearCapital(s.capital)}</td>
    <td>${s.periodos || "-"}</td>
    <td>${formatearGanancia(s.ganancia)}</td>
    <td>${s.unidad || "-"}</td>
    <td>${formatearFecha(s.fecha)}</td>
    <td>${s.carpeta || "-"}</td>
  `;

  if (Array.isArray(s.reingresos)) {
    s.reingresos.forEach(r => {
      const subRow = tbody.insertRow();
      subRow.style.fontStyle = "italic";
      subRow.style.backgroundColor = "#f9f9f9";
      subRow.innerHTML = `
  <td>${formatearCapital(r.capital)}</td>
  <td>-</td>
  <td><i>${formatearGanancia(r.tasa)}</i></td>
  <td>-</td>
  <td><i>${formatearFecha(r.fecha)}</i></td>
  <td><i>Reingreso</i></td>
`;

    });
  }
});

generarCalendarioDePagos(solicitudesTotales);
}

  async function buscarCarpeta() {
    const numero = document.getElementById("numeroCarpetaInput").value.trim();
    const contenedor = document.getElementById("resultadoCarpeta");
    contenedor.innerHTML = "";

    if (!numero) {
      contenedor.innerHTML = "<p>Ingresá un número de carpeta.</p>";
      return;
    }

    const snap = await getDocs(query(solicitudesRef, where("carpeta", "==", numero)));
    if (snap.empty) {
      contenedor.innerHTML = "<p>No se encontró ninguna carpeta con ese número.</p>";
      return;
    }

    const datos = snap.docs[0].data();
    contenedor.innerHTML = `
      <p><strong>Capital:</strong> ${formatearCapital(datos.capital)}</p>
      <p><strong>Períodos:</strong> ${datos.periodos}</p>
      <p><strong>Ganancia:</strong> ${formatearGanancia(datos.ganancia)}</p>
      <p><strong>Unidad:</strong> ${datos.unidad}</p>
      <p><strong>Fecha:</strong> ${formatearFecha(datos.fecha)}</p>
      <button onclick="agregarCarpetaAlPerfil('${numero}')">Agregar a mi perfil</button>
    `;
  }

  async function agregarCarpetaAlPerfil(numero) {
    if (!usuarioDocId) return;
    const ref = doc(collection(db, `usuarios/${usuarioDocId}/carpetasVinculadas`));
    await setDoc(ref, { carpeta: numero });
    mostrarMensajePopup("Carpeta agregada a tu perfil.");
    document.getElementById("resultadoCarpeta").innerHTML = "";
    await cargarSolicitudesDelUsuario(usuarioActual.dni);
  }

  function mostrarPopup(solicitud) {
    const popup = document.getElementById("popupOverlay");
    const contenido = document.getElementById("popupInfo");
    contenido.innerHTML = `
  <p><strong>Capital:</strong> ${formatearCapital(solicitud.capital)}</p>
  <p><strong>Períodos:</strong> ${solicitud.periodos}</p>
  <p><strong>Ganancia:</strong> ${formatearGanancia(solicitud.ganancia)}</p>
  <p><strong>Unidad:</strong> ${solicitud.unidad}</p>
  <p><strong>Fecha:</strong> ${formatearFecha(solicitud.fecha)}</p>
  <p><strong>Carpeta:</strong> ${solicitud.carpeta}</p>
`;

if (Array.isArray(solicitud.reingresos) && solicitud.reingresos.length > 0) {
  contenido.innerHTML += `<hr><p><strong>Reingresos:</strong></p>`;
  solicitud.reingresos.forEach((r, i) => {
    contenido.innerHTML += `
      <p>#${i + 1}</p>
      <p>Capital: ${formatearCapital(r.capital)}</p>
      <p>Tasa: ${formatearGanancia(r.tasa)}</p>
      <p>Fecha: ${formatearFecha(r.fecha)}</p>
      <hr>
    `;
  });
}
    popup.classList.remove("hidden");
  }

  function cerrarPopup() {
    document.getElementById("popupOverlay").classList.add("hidden");
  }

  function recuperarContrasena() {
    alert("Por favor contactate con soporte para recuperar tu contraseña.");
  }

  // ✅ Registrar funciones globales para usar con onclick
  Object.assign(window, {
  mostrarLogin,
  mostrarRegistro,
  cerrarSesion,
  habilitarEdicion,
  cancelarEdicion,
  volverAlInicio,
  mostrarFormularioCarpeta,
  buscarCarpeta,
  agregarCarpetaAlPerfil,
  recuperarContrasena,
  mostrarPopup,
  cerrarPopup,
  verDetalleCarpeta,
  cerrarPopupCalendario
});


  // Form listeners
  document.getElementById("registerForm").addEventListener("submit", registrar);
  document.getElementById("loginForm").addEventListener("submit", login);
  document.getElementById("perfilForm").addEventListener("submit", guardarCambiosPerfil);

  async function generarCalendarioDePagos(solicitudes) {
  const container = document.getElementById("calendarioPagosContainer");
  const headerRow = document.getElementById("calendarioHeader");
  const tbody = document.querySelector("#tablaCalendarioPagos tbody");

  tbody.innerHTML = "";
  let fechasPagos = [];

  const cuotasSnap = await getDocs(collection(db, "cuotas"));
  const cuotasMap = {};
  cuotasSnap.forEach(doc => {
    const data = doc.data();
    const idSanitizado = `${data.carpeta}_${data.mes}`.replaceAll("/", "-");
    cuotasMap[idSanitizado] = data;
  });

  const datosPorCarpeta = solicitudes.map(s => {
    const pagos = [];
    const { carpeta, capital, ganancia, periodos, fecha, retiroMensual = true, reingresos = [] } = s;
    if (!carpeta || !capital || !ganancia || !periodos || !fecha) return null;

    const capInicial = parseFloat(capital.toString().replace(/[^\d,.-]/g, '').replace(',', '.'));
    const ganInicial = parseFloat(ganancia.toString().replace(/[^\d,.-]/g, '').replace(',', '.'));
    if (isNaN(capInicial) || isNaN(ganInicial)) return null;

    const tasaInicial = ganInicial > 1 ? ganInicial / 100 : ganInicial;
    const [y, m, d] = fecha.split("-").map(Number);
    const fechaInicio = new Date(y, m - 1, d);

    const reingresosOrdenados = [...(reingresos || [])].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

    for (let i = 0; i < parseInt(periodos); i++) {
      const fechaPago = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth() + i + 1, 1);
      const key = `${fechaPago.getFullYear()}-${String(fechaPago.getMonth() + 1).padStart(2, "0")}`;
      fechasPagos.push(key);

      let cap = capInicial;
      let tasa = tasaInicial;

      for (const r of reingresosOrdenados) {
        const fechaR = new Date(r.fecha);
        const fechaEfectiva = new Date(fechaR.getFullYear(), fechaR.getMonth() + 2, 1);
        if (fechaPago >= fechaEfectiva) {
          cap += parseFloat(r.capital);
          const t = parseFloat(r.tasa);
          if (!isNaN(t)) tasa = t > 1 ? t / 100 : t;
        }
      }

      let montoCalculado = cap * tasa;
      if (i === 0) {
        const diasMes = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth() + 1, 0).getDate();
        const diasUsados = diasMes - fechaInicio.getDate() + 1;
        montoCalculado *= diasUsados / diasMes;
      }

      const idCuota = `${carpeta}_${key}`.replaceAll("/", "-");
      const cuotaManual = cuotasMap[idCuota];

      pagos.push({
        key,
        monto: cuotaManual && typeof cuotaManual.monto === "number" ? cuotaManual.monto : montoCalculado
      });
    }

    return { carpeta, pagos, retiroMensual, capital: capInicial };
  }).filter(Boolean);

  const mesesUnicos = Array.from(new Set(fechasPagos)).sort((a, b) => new Date(a) - new Date(b));

  headerRow.innerHTML = "<th>N° Carpeta</th>" + mesesUnicos.map(k => {
    const [a, m] = k.split("-");
    return `<th>${m}/${a.slice(2)}</th>`;
  }).join("");

  const hoy = new Date();
  const hoyKey = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, "0")}`;

  datosPorCarpeta.forEach(({ carpeta, pagos, retiroMensual, capital }) => {
    const row = document.createElement("tr");
    row.innerHTML = `<td><button class="boton-carpeta" onclick='verDetalleCarpeta(${JSON.stringify(pagos)}, "${carpeta}", ${retiroMensual !== false}, ${capital})'>${carpeta}</button></td>`;

    const pagosMap = Object.fromEntries(pagos.map(p => [p.key, p.monto]));

    mesesUnicos.forEach(k => {
      let className = "";
      let contenido = "";

      if (pagosMap[k]) {
        if (k < hoyKey) className = "cuota-pasada";
        else if (k === hoyKey) className = "cuota-actual";
        else className = "cuota-futura";

        contenido = `USD ${Math.round(pagosMap[k]).toLocaleString("de-DE")}`;
      }

      if (retiroMensual === false && contenido) {
        contenido = `<s>${contenido}</s>`;
      }

      row.innerHTML += `<td class="${className}">${contenido}</td>`;
    });

    tbody.appendChild(row);
  });

  container.classList.remove("hidden");
}
function verDetalleCarpeta(pagos, carpeta, retiroMensual = true, capital = null) {
  let yaCobrado = 0;
  let aCobrarHoy = 0;
  let restaCobrar = 0;
  const hoy = new Date();
  const hoyKey = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, "0")}`;
  pagos.forEach(p => {
    if (!retiroMensual) {
      restaCobrar += p.monto;
    } else {
      if (p.key < hoyKey) yaCobrado += p.monto;
      else if (p.key === hoyKey) aCobrarHoy += p.monto;
      else restaCobrar += p.monto;
    }
  });
  const capitalFormateado = capital ? `USD ${Math.round(capital).toLocaleString("de-DE")}` : "-";
  const contenedor = document.getElementById("popupCarpetaInfo");
  contenedor.innerHTML = `
    <p><strong>Carpeta:</strong> ${carpeta}</p>
    <p><strong>Ganancia Acumulada:</strong> ${retiroMensual ? `USD ${Math.round(yaCobrado).toLocaleString("de-DE")}` : "-"}</p>
    <p><strong>A cobrar este mes:</strong> ${retiroMensual ? `USD ${Math.round(aCobrarHoy).toLocaleString("de-DE")}` : "-"}</p>
<p><strong>Ganancia Estimada:</strong> USD ${Math.round(restaCobrar).toLocaleString("de-DE")} <span style="font-style: italic; color: #888;">+ capital invertido:</span> ${capitalFormateado}</p>
  `;
  document.getElementById("popupCarpetaCalendario").classList.remove("hidden");
}
function cerrarPopupCalendario() {
  document.getElementById("popupCarpetaCalendario").classList.add("hidden");
}
document.querySelector('[onclick="mostrarLogin()"]').onclick = mostrarLogin;
document.querySelector('[onclick="mostrarRegistro()"]').onclick = mostrarRegistro;
</script>
</body>
</html>
